<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Relat√≥rios Agr√≠colas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        :root {
            --agri-green-primary: #2E7D32;
            --agri-green-secondary: #4CAF50;
            --agri-orange-accent: #FF9800;
            --agri-bg-light: #F1F8E9;
            --agri-text-dark: #1B5E20;
            --radius-base: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--agri-bg-light);
            color: var(--agri-text-dark);
        }
        .login-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--agri-green-primary) 0%, var(--agri-green-secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        .logo-container i, .logo-container h2 { color: var(--agri-green-primary); }
        .form-control:focus {
            border-color: var(--agri-green-primary);
            box-shadow: 0 0 0 0.2rem rgba(46, 125, 50, 0.25);
        }
        .btn-success {
            background-color: var(--agri-green-primary);
            border-color: var(--agri-green-primary);
            padding: 12px;
            border-radius: var(--radius-base);
        }
        .btn-success:hover {
            background-color: var(--agri-green-secondary);
            border-color: var(--agri-green-secondary);
        }
        .card {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        .card-header {
            background-color: #f8f9fa;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: var(--radius-lg);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--agri-green-primary);
            background-color: #e8f5e8;
        }
        .table thead th {
            border-bottom: 2px solid var(--agri-green-primary);
            color: var(--agri-text-dark);
            background-color: #f8f9fa;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: var(--agri-green-primary) !important;
            border-color: var(--agri-green-primary) !important;
            color: white !important;
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .progress-bar { background-color: var(--agri-green-primary); }
        .summary-card {
            border: none; box-shadow: var(--shadow-sm); transition: transform 0.2s ease; color: white;
        }
        .summary-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .summary-card-toneladas { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .summary-card-distancia { background: linear-gradient(135deg, #2196F3, #1976d2); }
        .summary-card-impureza { background: linear-gradient(135deg, #FF9800, #f57c00); }
        .summary-card-atr { background: linear-gradient(135deg, #9C27B0, #7b1fa2); }
        .summary-card h3 { font-size: 1.75rem; }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="logo-container text-center mb-4">
                <i class="fas fa-seedling fa-3x"></i>
                <h2 class="mt-3">Relat√≥rios Agr√≠colas</h2>
                <p class="text-muted">Sistema de Gest√£o de Dados</p>
            </div>
            <form id="loginForm">
                <div class="mb-3"><label for="username" class="form-label">Usu√°rio</label><div class="input-group"><span class="input-group-text"><i class="fas fa-user"></i></span><input type="text" class="form-control" id="username" placeholder="Digite seu usu√°rio" required></div></div>
                <div class="mb-3"><label for="password" class="form-label">Senha</label><div class="input-group"><span class="input-group-text"><i class="fas fa-lock"></i></span><input type="password" class="form-control" id="password" placeholder="Digite sua senha" required></div></div>
                <div class="d-grid"><button type="submit" class="btn btn-success btn-lg">Entrar</button></div>
            </form>
        </div>
    </div>

    <div id="mainApp" class="d-none">
        <nav class="navbar navbar-expand-lg navbar-dark bg-success"><div class="container-fluid"><a class="navbar-brand" href="#"><i class="fas fa-seedling me-2"></i> Relat√≥rios Agr√≠colas</a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNav"><ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link active" href="#" onclick="showSection('dashboard')">Dashboard</a></li><li class="nav-item"><a class="nav-link" href="#" onclick="showSection('reports')">Relat√≥rios</a></li><li class="nav-item" id="adminMenu" style="display: none;"><a class="nav-link" href="#" onclick="showSection('admin')">Administra√ß√£o</a></li></ul><ul class="navbar-nav"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"><i class="fas fa-user"></i> <span id="currentUser"></span></a><ul class="dropdown-menu dropdown-menu-end"><li><a class="dropdown-item" href="#" onclick="logout()">Sair</a></li></ul></li></ul></div></div></nav>

        <main id="dashboardSection" class="container-fluid py-4">
            <h2 class="mb-4">Dashboard</h2>
            <div class="row mb-4"><div class="col-md-3 mb-3"><div class="card text-white bg-primary h-100"><div class="card-body"><div class="d-flex justify-content-between"><div><h5 class="card-title">üì¶ Toneladas 2025</h5><h3 id="totalCana">Sem dados</h3></div><i class="fas fa-weight-hanging fa-2x opacity-75"></i></div></div></div></div><div class="col-md-3 mb-3"><div class="card text-white bg-success h-100"><div class="card-body"><div class="d-flex justify-content-between"><div><h5 class="card-title">üçØ ATR M√©dio 2025</h5><h3 id="atrMedio">Sem dados</h3></div><i class="fas fa-chart-line fa-2x opacity-75"></i></div></div></div></div><div class="col-md-3 mb-3"><div class="card text-white bg-warning h-100"><div class="card-body"><div class="d-flex justify-content-between"><div><h5 class="card-title">üìç Dist. M√©dia 2025</h5><h3 id="distMedia">Sem dados</h3></div><i class="fas fa-route fa-2x opacity-75"></i></div></div></div></div><div class="col-md-3 mb-3"><div class="card text-white bg-danger h-100"><div class="card-body"><div class="d-flex justify-content-between"><div><h5 class="card-title">‚ö†Ô∏è Impureza M√©dia 2025</h5><h3 id="impurezaMedia">Sem dados</h3></div><i class="fas fa-exclamation-triangle fa-2x opacity-75"></i></div></div></div></div></div>
            <div class="row"><div class="col-md-6 mb-4"><div class="card"><div class="card-header"><h5 class="mb-0">Participa√ß√£o por Unidade</h5></div><div class="card-body"><div class="text-center py-4"><i class="fas fa-chart-pie fa-3x text-muted mb-3"></i><p class="text-muted">Aguardando dados da planilha</p></div><canvas id="unidadeChart" class="d-none" height="200"></canvas></div></div></div><div class="col-md-6 mb-4"><div class="card"><div class="card-header"><h5 class="mb-0">Participa√ß√£o por Frente</h5></div><div class="card-body"><div class="text-center py-4"><i class="fas fa-chart-bar fa-3x text-muted mb-3"></i><p class="text-muted">Aguardando dados da planilha</p></div><canvas id="frenteChart" class="d-none" height="200"></canvas></div></div></div></div>
        </main>

        <main id="reportsSection" class="container-fluid py-4 d-none">
            <h2 class="mb-4">Relat√≥rios</h2>
            <div class="card mb-4"><div class="card-header"><h5 class="mb-0">Filtros</h5></div><div class="card-body"><div class="row g-3 align-items-end"><div class="col-md-2"><label class="form-label">Data In√≠cio</label><input type="date" class="form-control" id="dataInicio"></div><div class="col-md-2"><label class="form-label">Data Fim</label><input type="date" class="form-control" id="dataFim"></div><div class="col-md-2"><label class="form-label">Unidade</label><select class="form-control" id="filtroUnidade"><option value="">Todas</option><option value="COPI">COPI</option><option value="RAF">RAF</option><option value="IASF">IASF</option></select></div><div class="col-md-2"><label class="form-label">Frente</label><select class="form-control" id="filtroFrente"><option value="">Todas</option><option value="92">92 - MEC</option><option value="94">94 - MAN</option><option value="135">135 - MEC</option></select></div><div class="col-md-2"><label class="form-label">Fazenda</label><input type="text" class="form-control" id="filtroFazenda" placeholder="C√≥digo"></div><div class="col-md-2"><label class="form-label">Zona</label><input type="number" class="form-control" id="filtroZona" placeholder="N√∫mero"></div></div><div class="mt-3"><button class="btn btn-primary" id="btnAplicarFiltros" onclick="aplicarFiltros()" disabled>Aplicar</button><button class="btn btn-secondary" id="btnLimparFiltros" onclick="limparFiltros()" disabled>Limpar</button><button class="btn btn-success" id="btnExportarExcel" onclick="exportarExcel()" disabled>Exportar Excel</button><button class="btn btn-danger" id="btnExportarPDF" onclick="exportarPDF()" disabled>Exportar PDF</button><small class="text-muted d-block mt-2" id="msgSemDados">Carregue uma planilha para habilitar filtros e exporta√ß√£o.</small></div></div></div>
            <div class="row mb-4" id="summaryCards" style="display: none;"><div class="col-md-3 mb-3"><div class="card summary-card summary-card-toneladas h-100"><div class="card-body"><div><h6 class="card-title">üì¶ Total Toneladas</h6><h3 id="summaryToneladas">0 t</h3></div></div></div></div><div class="col-md-3 mb-3"><div class="card summary-card summary-card-distancia h-100"><div class="card-body"><div><h6 class="card-title">üìç M√©dia Dist√¢ncia</h6><h3 id="summaryDistancia">0 km</h3></div></div></div></div><div class="col-md-3 mb-3"><div class="card summary-card summary-card-impureza h-100"><div class="card-body"><div><h6 class="card-title">‚ö†Ô∏è M√©dia Impureza</h6><h3 id="summaryImpureza">0%</h3></div></div></div></div><div class="col-md-3 mb-3"><div class="card summary-card summary-card-atr h-100"><div class="card-body"><div><h6 class="card-title">üçØ M√©dia ATR</h6><h3 id="summaryATR">0 kg/t</h3></div></div></div></div></div>
            <div class="card"><div class="card-header"><h5 class="mb-0">Resultados</h5></div><div class="card-body"><div class="table-responsive"><table id="reportsTable" class="table table-striped table-hover w-100"><thead><tr><th>Unidade</th><th>Frente</th><th>Fazenda</th><th>Zona</th><th>Talh√£o</th><th>TC (t)</th><th>% Part.</th><th>Dist.M√©d (km)</th><th>ATR (kg/t)</th><th>IMP Min (%)</th></tr></thead>
            <tbody></tbody>
            </table></div></div></div>
        </main>
        
        <main id="adminSection" class="container-fluid py-4 d-none">
            <h2 class="mb-4">Painel Administrativo</h2>
            <div class="row mb-4">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Upload de Planilha</h5></div>
                        <div class="card-body">
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5>Carregue sua planilha Excel</h5>
                                <p class="text-muted">Os dados da planilha ser√£o salvos no banco de dados.</p>
                                <small class="text-muted d-block">Formatos: .xlsx, .xls</small>
                                <input type="file" id="excelFile" accept=".xlsx,.xls" class="d-none">
                            </div>
                            <div id="uploadProgress" class="d-none">
                                <div class="progress mb-3" style="height: 8px;"><div class="progress-bar" role="progressbar" style="width: 0%"></div></div>
                                <p id="uploadStatus">Processando...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Estat√≠sticas</h5></div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6"><h3><i class="fas fa-users text-primary"></i> <span id="totalUsuarios">1</span></h3><p class="text-muted">Usu√°rios</p></div>
                                <div class="col-6"><h3><i class="fas fa-file-alt text-success"></i> <span id="totalRegistros">0</span></h3><p class="text-muted">Registros</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><h5 class="mb-0">Adicionar Relat√≥rio Manual</h5></div>
                        <div class="card-body">
                             <form id="formRelatorio">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="unidadeInput" class="form-label">Unidade</label>
                                        <input type="text" class="form-control" id="unidadeInput" required placeholder="Ex: COPI">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="toneladasInput" class="form-label">Toneladas</label>
                                        <input type="number" step="0.01" class="form-control" id="toneladasInput" required placeholder="Ex: 150.5">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Salvar no Banco de Dados</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4"><div class="col-12"><div class="card"><div class="card-header d-flex justify-content-between align-items-center"><h5 class="mb-0">Gerenciar Usu√°rios</h5><button class="btn btn-primary" onclick="showUserModal()"><i class="fas fa-plus"></i> Novo Usu√°rio</button></div><div class="card-body"><div class="table-responsive"><table id="usersTable" class="table table-striped w-100"><thead><tr><th>Usu√°rio</th><th>Perfil</th><th>√öltimo Acesso</th><th>A√ß√µes</th></tr></thead><tbody></tbody></table></div></div></div></div></div>
            <div class="row"><div class="col-12"><div class="card"><div class="card-header"><h5 class="mb-0">Logs de Atividade</h5></div><div class="card-body"><div class="table-responsive"><table id="logsTable" class="table table-striped table-sm w-100"><thead><tr><th>Data/Hora</th><th>Usu√°rio</th><th>A√ß√£o</th><th>Detalhes</th></tr></thead><tbody></tbody></table></div></div></div></div></div>
        </main>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="userModalTitle">Novo Usu√°rio</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="userForm"><div class="mb-3"><label class="form-label">Usu√°rio</label><input type="text" class="form-control" id="modalUsername" required></div><div class="mb-3"><label class="form-label">Senha</label><input type="password" class="form-control" id="modalPassword" required><small class="form-text text-muted">Deixe em branco para n√£o alterar a senha existente.</small></div><div class="mb-3"><label class="form-label">Perfil</label><select class="form-control" id="modalRole" required><option value="user">Usu√°rio</option><option value="admin">Administrador</option></select></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="saveUser()">Salvar</button></div></div></div></div>
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>
    <div id="loadingOverlay" class="loading-overlay d-none"><div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status"><span class="visually-hidden">Carregando...</span></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Sistema de Relat√≥rios Agr√≠colas
        const SYSTEM_CONFIG = {
            unidades: { 40: 'COPI', 52: 'RAF', 60: 'IASF' },
            frentes: { '92': 'MEC', '94': 'MAN', '135': 'MEC' },
        };

        let currentUser = null;
        let agriculturalData = [];
        let filteredData = [];
        let reportsTable = null;
        let usersTable = null;
        let logsTable = null;
        let charts = {};
        // O sistema de usu√°rios agora √© local, sem persist√™ncia em banco por enquanto.
        let systemUsers = [{ id: 1, username: 'admin', password: 'admin123', role: 'admin', lastAccess: null }];
        let systemLogs = [];

        // NOVA FUN√á√ÉO PARA SALVAR DADOS NO BANCO DE DADOS NETLIFY/NEON
        async function salvarDadosNoBanco(event) {
            event.preventDefault(); // Impede o formul√°rio de recarregar a p√°gina

            const dadosParaSalvar = {
                unidade: document.getElementById('unidadeInput').value,
                toneladas: parseFloat(document.getElementById('toneladasInput').value)
            };
            
            showLoading(); // Mostra o spinner de carregamento

            try {
                // O seu site (frontend) chama a fun√ß√£o no servidor (backend)
                const response = await fetch('/.netlify/functions/salvar-relatorio', {
                    method: 'POST', // Estamos enviando dados
                    body: JSON.stringify(dadosParaSalvar) // Converte os dados para texto JSON
                });

                const resultado = await response.json();

                if (!response.ok) {
                    // Se o servidor retornou um erro
                    throw new Error(resultado.error);
                }

                showToast(`Sucesso! Relat√≥rio salvo com ID: ${resultado.data.id}`, 'success');
                document.getElementById('formRelatorio').reset(); // Limpa o formul√°rio

            } catch (error) {
                console.error('Falha ao salvar:', error);
                showToast(`Erro: ${error.message}`, 'error');
            } finally {
                hideLoading(); // Esconde o spinner de carregamento
            }
        }

        function showLoading() { document.getElementById('loadingOverlay').classList.remove('d-none'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('d-none'); }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastType = type === 'error' ? 'danger' : type;
            const toastHTML = `<div class="toast align-items-center text-white bg-${toastType} border-0" role="alert"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const newToast = toastContainer.lastElementChild;
            new bootstrap.Toast(newToast).show();
            newToast.addEventListener('hidden.bs.toast', () => newToast.remove());
        }

        async function logActivity(action, details = '') {
            const logEntry = { 
                id: systemLogs.length + 1, 
                timestamp: new Date().toISOString(), 
                user: currentUser?.username || 'Sistema', 
                action, 
                details 
            };
            systemLogs.unshift(logEntry);
            if (systemLogs.length > 100) systemLogs.pop();
        }

        function formatDateTime(dateString) { return new Date(dateString).toLocaleString('pt-BR'); }
        function formatNumber(num, decimals = 1) { return Number(num).toLocaleString('pt-BR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }

        async function initializeApp() {
            setupEventListeners();
            // L√≥gica de carregar dados do banco de dados pode ser adicionada aqui no futuro
            showLoginScreen();
            logActivity('Sistema iniciado');
        }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('excelFile');
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', (e) => { e.currentTarget.classList.remove('dragover'); });
            uploadArea.addEventListener('drop', handleFileDrop);
            fileInput.addEventListener('change', handleFileSelect);
            document.getElementById('userForm').addEventListener('submit', (e) => { e.preventDefault(); saveUser(); });

            // VINCULA A FUN√á√ÉO DE SALVAR AO NOVO FORMUL√ÅRIO
            // Fazemos isso aqui para garantir que o listener s√≥ seja adicionado uma vez
            const formRelatorio = document.getElementById('formRelatorio');
            if(formRelatorio) {
                formRelatorio.addEventListener('submit', salvarDadosNoBanco);
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            showLoading();
            setTimeout(() => {
                const user = systemUsers.find(u => u.username === username && u.password === password);
                if (user) {
                    currentUser = user;
                    user.lastAccess = new Date().toISOString();
                    logActivity('Login realizado', `Usu√°rio: ${username}`);
                    showToast('Login realizado com sucesso!', 'success');
                    showMainApp();
                } else {
                    showToast('Usu√°rio ou senha incorretos.', 'error');
                }
                hideLoading();
            }, 500);
        }

        function logout() {
            logActivity('Logout realizado', `Usu√°rio: ${currentUser.username}`);
            currentUser = null;
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('d-none');
            document.getElementById('mainApp').classList.add('d-none');
            document.getElementById('loginForm').reset();
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('d-none');
            document.getElementById('mainApp').classList.remove('d-none');
            document.getElementById('currentUser').textContent = currentUser.username;
            document.getElementById('adminMenu').style.display = currentUser.role === 'admin' ? 'block' : 'none';
            showSection('dashboard');
        }

        function showSection(sectionId) {
            ['dashboardSection', 'reportsSection', 'adminSection'].forEach(s => document.getElementById(s).classList.add('d-none'));
            document.getElementById(sectionId + 'Section').classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`.nav-link[onclick="showSection('${sectionId}')"]`).classList.add('active');
            
            switch (sectionId) {
                case 'dashboard': loadDashboard(); break;
                case 'reports': loadReports(); break;
                case 'admin':
                    if (currentUser.role === 'admin') loadAdmin();
                    else { showToast('Acesso negado.', 'error'); showSection('dashboard'); }
                    break;
            }
        }

        function loadDashboard() {
            // No futuro, esta fun√ß√£o carregar√° dados do banco de dados.
            const data2025 = agriculturalData.filter(item => item.data && item.data.includes('2025'));
            if (data2025.length === 0) {
                document.getElementById('totalCana').textContent = 'Sem dados';
                document.getElementById('atrMedio').textContent = 'Sem dados';
                document.getElementById('distMedia').textContent = 'Sem dados';
                document.getElementById('impurezaMedia').textContent = 'Sem dados';
            } else {
                const totalCana = data2025.reduce((sum, item) => sum + item.entradaCana, 0);
                document.getElementById('totalCana').textContent = formatNumber(totalCana, 1) + ' t';
                document.getElementById('atrMedio').textContent = formatNumber(data2025.reduce((sum, item) => sum + (item.atr * item.entradaCana), 0) / totalCana, 1) + ' kg/t';
                document.getElementById('distMedia').textContent = formatNumber(data2025.reduce((sum, item) => sum + item.raioMedio, 0) / data2025.length, 1) + ' km';
                document.getElementById('impurezaMedia').textContent = formatNumber(data2025.reduce((sum, item) => sum + item.impurezaMineral, 0) / data2025.length, 1) + '%';
            }

            const hasData = data2025.length > 0;
            document.getElementById('unidadeChart').classList.toggle('d-none', !hasData);
            document.getElementById('frenteChart').classList.toggle('d-none', !hasData);
            document.querySelectorAll('#dashboardSection .card-body .text-center').forEach(el => el.style.display = hasData ? 'none' : 'block');

            if(hasData) {
                createChart('unidadeChart', 'doughnut', data2025.reduce((acc, item) => { acc[item.unidade] = (acc[item.unidade] || 0) + item.entradaCana; return acc; }, {}));
                createChart('frenteChart', 'bar', data2025.reduce((acc, item) => {
                    const match = item.descricaoFrente.match(/F (\d+)/);
                    if (match) { const frente = `${match[1]} - ${SYSTEM_CONFIG.frentes[match[1]] || 'N/A'}`; acc[frente] = (acc[frente] || 0) + item.entradaCana; }
                    return acc;
                }, {}));
            }
        }
        
        function createChart(chartId, type, data) {
            const ctx = document.getElementById(chartId).getContext('2d');
            if (charts[chartId]) charts[chartId].destroy();
            const chartData = { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ['#1FB8CD', '#FFC185', '#B4413C', '#5D878F', '#DB4545'], borderWidth: type === 'doughnut' ? 2 : 1 }] };
            const options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'doughnut', position: 'bottom' } }, scales: { y: { beginAtZero: true, display: type === 'bar' } } };
            charts[chartId] = new Chart(ctx, { type, data: chartData, options });
        }

        function loadReports() {
            initializeReportsTable();
            aplicarFiltros(true);
            updateReportButtons();
        }

        function initializeReportsTable() {
            if ($.fn.DataTable.isDataTable('#reportsTable')) return;
            reportsTable = $('#reportsTable').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json',
                    emptyTable: '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle fa-2x mb-2"></i><br>Nenhum dado dispon√≠vel. Carregue uma planilha para come√ßar.</div>'
                },
                pageLength: 25,
                responsive: true,
                order: [[2, 'asc'], [3, 'asc'], [4, 'asc']],
                columnDefs: [ { targets: [5, 6, 7, 8, 9], className: 'text-end' } ]
            });
        }
        
        function aplicarFiltros(isInitialLoad = false) {
            // ... (restante da sua l√≥gica de filtros)
        }

        function limparFiltros() {
            // ... (restante da sua l√≥gica de filtros)
        }

        function updateReportButtons() {
            const hasData = agriculturalData.length > 0;
            ['btnAplicarFiltros', 'btnLimparFiltros', 'btnExportarExcel', 'btnExportarPDF'].forEach(id => document.getElementById(id).disabled = !hasData);
            document.getElementById('msgSemDados').style.display = hasData ? 'none' : 'block';
        }

        function updateSummaryCards() {
            // ... (restante da sua l√≥gica)
        }

        function updateReportsTable() {
            // ... (restante da sua l√≥gica)
        }
        
        function exportarExcel() {
            // ... (restante da sua l√≥gica)
        }

        function exportarPDF() {
           // ... (restante da sua l√≥gica)
        }

        function loadAdmin() {
            updateAdminStats();
            if (!usersTable) usersTable = $('#usersTable').DataTable({ language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json' }, pageLength: 5, responsive: true, order: [[0, 'asc']] });
            usersTable.clear();
            systemUsers.forEach(user => { usersTable.row.add([ user.username, `<span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-primary'}">${user.role}</span>`, user.lastAccess ? formatDateTime(user.lastAccess) : 'Nunca', `<button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})"><i class="fas fa-edit"></i></button> ${user.id !== 1 ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})"><i class="fas fa-trash"></i></button>` : ''}` ]); });
            usersTable.draw();

            if (!logsTable) logsTable = $('#logsTable').DataTable({ language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json' }, pageLength: 10, responsive: true, order: [[0, 'desc']] });
            logsTable.clear();
            systemLogs.forEach(log => { logsTable.row.add([ `<small>${formatDateTime(log.timestamp)}</small>`, log.user, log.action, `<small>${log.details}</small>` ]); });
            logsTable.draw();
        }

        function updateAdminStats() {
            document.getElementById('totalUsuarios').textContent = systemUsers.length;
            // A contagem de registros agora vir√° do banco de dados
            // document.getElementById('totalRegistros').textContent = agriculturalData.length.toLocaleString('pt-BR');
        }

        function handleFileDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) processExcelFile(e.dataTransfer.files[0]); }
        function handleFileSelect(e) { if (e.target.files.length > 0) processExcelFile(e.target.files[0]); }
        
        async function processExcelFile(file) {
            // Esta fun√ß√£o agora precisa ser modificada para enviar cada linha para o banco de dados
            // usando a fun√ß√£o salvarDadosNoBanco ou uma fun√ß√£o similar em lote.
            showToast('Funcionalidade de Upload de Planilha precisa ser adaptada para o novo banco de dados.', 'warning');
        }
        
        function showUploadProgress() { /* ... */ }
        function hideUploadProgress(isError = false) { /* ... */ }
        async function processExcelData(jsonData, fileName) { /* ... */ }
        function formatExcelDate(excelDate) { /* ... */ }
        
        const userModal = new bootstrap.Modal(document.getElementById('userModal'));
        function showUserModal(userId = null) {
            const form = document.getElementById('userForm'); form.reset(); delete form.dataset.editId;
            document.getElementById('modalPassword').placeholder = "Senha (obrigat√≥ria)";
            if (userId) {
                const user = systemUsers.find(u => u.id === userId);
                if (user) {
                    document.getElementById('userModalTitle').textContent = 'Editar Usu√°rio';
                    document.getElementById('modalUsername').value = user.username;
                    document.getElementById('modalPassword').placeholder = "Deixe em branco para n√£o alterar";
                    document.getElementById('modalRole').value = user.role; form.dataset.editId = userId;
                }
            } else document.getElementById('userModalTitle').textContent = 'Novo Usu√°rio';
            userModal.show();
        }

        function editUser(userId) { showUserModal(userId); }
        
        async function deleteUser(userId) { /* ... */ }

        async function saveUser() { /* ... */ }
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
